<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Menadžer | Aranžmani</title>
    <link href="../Content/tailwind.css" rel="stylesheet">
    <script src="../Scripts/jquery-3.7.1.min.js"></script>
    <style>
        /* male sitnice za preview slike */
        #previewImg {
            max-width: 200px;
            max-height: 160px;
            display: block;
            margin-top: 8px;
            border-radius: 6px;
        }
    </style>
</head>
<body class="p-8">
    <h1 class="text-3xl font-bold mb-6">Moji aranžmani</h1>

    <div class="flex gap-2 mb-4">
        <input type="text" id="pretragaNaziv" placeholder="Pretraga po nazivu"
               class="border border-blue-500 rounded px-3 py-1 focus:outline-none focus:border-blue-600">
        <select id="pretragaTip" class="border border-blue-500 rounded px-3 py-1 focus:outline-none focus:border-blue-600">
            <option value="">Svi tipovi aranžmana</option>
            <option value="0">Noćenje sa doručkom</option>
            <option value="1">Polupansion</option>
            <option value="2">Pun pansion</option>
            <option value="3">All inclusive</option>
            <option value="4">Najam apartmana</option>
        </select>
        <button id="dugmeFiltriraj" class="bg-blue-500 text-white px-4 py-1 rounded hover:bg-blue-600">Filtriraj</button>
        <input type="reset" id="dugmeResetuj" class="bg-red-500 text-white px-4 py-1 rounded hover:bg-red-600" value="Resetuj">
        <button id="dugmeDodaj" class="bg-green-500 text-white px-4 py-1 rounded hover:bg-green-600">Dodaj aranžman</button>
    </div>

    <table id="tabelaAranzmana" class="w-full text-center border rounded-lg overflow-hidden">
        <thead class="bg-blue-400 text-gray-700 uppercase">
            <tr>
                <th class="px-4 py-2">Naziv</th>
                <th class="px-4 py-2">Tip aranžmana</th>
                <th class="px-4 py-2">Tip prevoza</th>
                <th class="px-4 py-2">Datum početka</th>
                <th class="px-4 py-2">Datum završetka</th>
                <th class="px-4 py-2">Maks putnika</th>
                <th class="px-4 py-2">Smestaj</th>
                <th class="px-4 py-2">Akcije</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Modal -->
    <div id="modalAranzman" class="fixed z-10 inset-0 overflow-y-auto" style="display:none;">
        <div class="flex items-end justify-center min-h-screen px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full p-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4" id="naslovModala">Dodaj Aranžman</h3>
                <input type="hidden" id="idAranzmana">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm">Naziv</label>
                        <input id="naziv" type="text" class="w-full border rounded px-3 py-2" />
                    </div>

                    <div>
                        <label class="block text-sm">Smestaj (odaberi)</label>
                        <select id="smestajId" class="w-full border rounded px-3 py-2">
                            <option value="">Odaberi smeštaj</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm">Tip aranžmana</label>
                        <select id="tipAranzmana" class="w-full border rounded px-3 py-2">
                            <option value="">Odaberi tip</option>
                            <option value="0">Noćenje sa doručkom</option>
                            <option value="1">Polupansion</option>
                            <option value="2">Pun pansion</option>
                            <option value="3">All inclusive</option>
                            <option value="4">Najam apartmana</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm">Tip prevoza</label>
                        <select id="tipPrevoza" class="w-full border rounded px-3 py-2">
                            <option value="">Odaberi tip prevoza</option>
                            <option value="0">Autobus</option>
                            <option value="1">Avion</option>
                            <option value="2">Autobus+Avion</option>
                            <option value="3">Individualan</option>
                            <option value="4">Ostalo</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm">Datum početka</label>
                        <input id="datumPocetka" type="date" class="w-full border rounded px-3 py-2" />
                    </div>

                    <div>
                        <label class="block text-sm">Datum završetka</label>
                        <input id="datumZavrsetka" type="date" class="w-full border rounded px-3 py-2" />
                    </div>

                    <div>
                        <label class="block text-sm">Maksimalan broj putnika</label>
                        <input id="maksPutnika" type="number" min="1" class="w-full border rounded px-3 py-2" />
                    </div>

                    <div>
                        <label class="block text-sm">Lokacija</label>
                        <input id="lokacija" type="text" class="w-full border rounded px-3 py-2" />
                    </div>

                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-sm">Kratak opis</label>
                        <textarea id="opis" class="w-full border rounded px-3 py-2" rows="3"></textarea>
                    </div>

                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-sm">Program putovanja</label>
                        <textarea id="program" class="w-full border rounded px-3 py-2" rows="4"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm">Poster (jpg/png) — kompresuje se i šalje kao base64</label>
                        <input id="posterFile" type="file" accept="image/*" class="w-full" />
                        <img id="previewImg" src="" alt="preview" style="display:none;" />
                        <div class="text-xs text-gray-500 mt-1">Ako ne odaberete novu sliku pri izmeni, biće sačuvana postojeća.</div>
                    </div>
                </div>

                <div class="mt-4 flex justify-end gap-2">
                    <button id="dugmeSacuvaj" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Sačuvaj</button>
                    <button id="dugmeOtkazi" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">Otkaži</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modalRezervacije" class="fixed z-20 inset-0 overflow-y-auto" style="display:none;">
        <div class="flex items-end justify-center min-h-screen px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full p-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Rezervacije aranžmana: <span id="nazivAranzmanaRez"></span></h3>
                <table id="tabelaRezervacija" class="w-full text-center border rounded-lg overflow-hidden">
                    <thead class="bg-gray-200 text-gray-700 uppercase">
                        <tr>
                            <th class="px-4 py-2">Ime klijenta</th>
                            <th class="px-4 py-2">Email</th>
                            <th class="px-4 py-2">Broj putnika</th>
                            <th class="px-4 py-2">Datum rezervacije</th>
                            <th class="px-4 py-2">Napomene</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="mt-4 flex justify-end">
                    <button id="dugmeZatvoriRez" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">Zatvori</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(function () {

            // pregled rezervacija
            $('#tabelaAranzmana').on('click', '.dugmePregledRez', function () {
                const aranzmanId = $(this).data('id');
                const naziv = $(this).closest('tr').find('td:eq(0)').text();
                $('#nazivAranzmanaRez').text(naziv);

                const tbody = $('#tabelaRezervacija tbody').empty();

                $.get(`http://localhost:51858/api/rezervacije/aranzman/${aranzmanId}`)
                    .done(resp => {
                        if (resp && resp.data && resp.data.length) {
                            resp.data.forEach(r => {
                                tbody.append(`
                            <tr>
                                <td>${r.ImeKlijenta}</td>
                                <td>${r.Email}</td>
                                <td>${r.BrojPutnika}</td>
                                <td>${r.DatumRezervacije}</td>
                                <td>${r.Napomene}</td>
                            </tr>
                        `);
                            });
                        } else {
                            tbody.append('<tr><td colspan="5">Nema rezervacija za ovaj aranžman</td></tr>');
                        }
                        $('#modalRezervacije').show();
                    })
                    .fail(() => alert('Greška pri dohvaćanju rezervacija'));
            });

            // zatvori modal
            $('#dugmeZatvoriRez').on('click', function () { $('#modalRezervacije').hide(); });


            // globalna var za poster base64
            let currentPosterBase64 = null;
            let isSaving = false;

            // pomoćne funkcije za datume
            function ddmmyyyyToIso(ddmm) {
                if (!ddmm) return '';
                const parts = ddmm.split('/');
                if (parts.length !== 3) return '';
                // dd/mm/yyyy -> yyyy-mm-dd
                return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
            }
            function isoToDdMmYyyy(iso) {
                if (!iso) return '';
                // iso may be "yyyy-mm-dd" or full datetime; take first 10 chars
                const d = iso.substring(0, 10);
                if (!d) return '';
                const p = d.split('-');
                if (p.length !== 3) return '';
                return `${p[2]}/${p[1]}/${p[0]}`;
            }

            // Parse enum value robustno: prihvati broj ili string
            function parseEnumValue(val, mapping) {
                if (val === null || val === undefined) return null;
                if (typeof val === 'number') return val;
                if (/^\d+$/.test(val)) return parseInt(val);
                // else try mapping from string names -> number
                if (mapping && mapping[val] !== undefined) return mapping[val];
                // fallback: try parseInt
                const n = parseInt(val);
                return isNaN(n) ? null : n;
            }

            const TipMap = {
                "NocenjeSDoruckom": 0, "Noćenje sa doručkom": 0, "0": 0, 0: 0,
                "Polupansion": 1, "1": 1, 1: 1,
                "PunPansion": 2, "Pun pansion": 2, "2": 2, 2: 2,
                "AllInclusive": 3, "All inclusive": 3, "3": 3, 3: 3,
                "NajamApartmana": 4, "Najam apartmana": 4, "4": 4, 4: 4
            };
            const PrevozMap = {
                "Autobus": 0, "0": 0, 0: 0,
                "Avion": 1, "1": 1, 1: 1,
                "AutobusAvion": 2, "Autobus+Avion": 2, "2": 2, 2: 2,
                "Individualan": 3, "3": 3, 3: 3,
                "Ostalo": 4, "4": 4, 4: 4
            };

            // prikaz liste
            function prikaziAranzmane(aranzmani) {
                const tbody = $('#tabelaAranzmana tbody').empty();
                aranzmani.forEach(a => {
                    // a may contain TipAranzmana and TipPrevoza as strings or numbers
                    const tip = typeof a.TipAranzmana === 'string' ? a.TipAranzmana : Object.keys(TipMap).find(k => TipMap[k] === a.TipAranzmana) || a.TipAranzmana;
                    const prevoz = typeof a.TipPrevoza === 'string' ? a.TipPrevoza : Object.keys(PrevozMap).find(k => PrevozMap[k] === a.TipPrevoza) || a.TipPrevoza;
                    const row = $(`
<tr>
        <td>${a.Naziv || ''}</td>
        <td>${tip}</td>
        <td>${prevoz}</td>
        <td>${a.DatumPocetka ? a.DatumPocetka.substring(0, 10) : ''}</td>
        <td>${a.DatumZavrsetka ? a.DatumZavrsetka.substring(0, 10) : ''}</td>
        <td>${a.MaksPutnika || a.MaksimalanBrojPutnika || 0}</td>
        <td>${a.SmestajNaziv || (a.SmestajId || '')}</td>
        <td>
            <button class="dugmeUredi bg-blue-500 text-white px-3 py-1 rounded mr-2" data-id="${a.Id}" ${!a.MozeUrediti ? 'disabled title="Samo kreator može menjati"' : ''}>Uredi</button>
            <button class="dugmeObrisi bg-red-500 text-white px-3 py-1 rounded mr-2" data-id="${a.Id}" ${!a.MozeUrediti ? 'disabled title="Samo kreator može brisati"' : ''}>Obriši</button>
            <button class="dugmePregledRez bg-green-600 text-white px-3 py-1 rounded" data-id="${a.Id}" data-naziv="${a.Id}">Pregled rezervacija</button>
        </td>
</tr>
`);
                    tbody.append(row);
                });
            }

            // dohvat aranžmana za menadžera
            function dohvatiAranzmane() {
                $.get('http://localhost:51858/api/aranzmani/menadzer')
                    .done(resp => {
                        if (resp && resp.data) prikaziAranzmane(resp.data);
                    })
                    .fail(() => console.error('Greška pri dohvaćanju aranžmana'));
            }

            // dohvat slobodnih smeštaja + dodaj trenutni ako nije slobodan
            function dohvatiDostupneSmestaje(odabraniId) {
                const select = $('#smestajId');
                select.empty().append('<option value="">Odaberi smeštaj</option>');

                $.get('http://localhost:51858/api/smestaji/slobodni')
                    .done(resp => {
                        const present = new Set();
                        if (resp && resp.data) {
                            resp.data.forEach(s => {
                                select.append(`<option value="${s.Id}">${s.Naziv} (${s.Tip})</option>`);
                                present.add(String(s.Id));
                            });
                        }
                        // ako imamo odabrani smestaj i nije u listi, dohvatimo ga pojedinačno
                        if (odabraniId) {
                            if (!present.has(String(odabraniId))) {
                                $.get(`http://localhost:51858/api/smestaji/get/${odabraniId}`)
                                    .done(r => {
                                        if (r && r.data) {
                                            const s = r.data;
                                            const tip = (typeof s.Tip === 'string') ? s.Tip : (s.Tip === 0 ? 'Hotel' : s.Tip === 1 ? 'Motel' : 'Vila');
                                            select.append(`<option value="${s.Id}" selected>${s.Naziv} (${tip})</option>`);
                                        }
                                    })
                                    .fail(() => {/* ignore */ });
                            } else {
                                select.val(odabraniId);
                            }
                        }
                    })
                    .fail(() => {
                        console.error('Ne mogu dohvatiti slobodne smeštaje');
                    });
            }

            // Helper: compress image to jpeg base64 (quality ~0.3)
            function compressFileToBase64(file, maxWidth = 1200, quality = 0.3, callback) {
                const reader = new FileReader();
                reader.onload = function (ev) {
                    const img = new Image();
                    img.onload = function () {
                        // scale to maxWidth preserving aspect ratio
                        let w = img.width, h = img.height;
                        if (w > maxWidth) {
                            const ratio = maxWidth / w;
                            w = Math.round(w * ratio);
                            h = Math.round(h * ratio);
                        }
                        const canvas = document.createElement('canvas');
                        canvas.width = w;
                        canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        // convert to jpeg with provided quality
                        try {
                            const dataUrl = canvas.toDataURL('image/jpeg', quality);
                            callback(null, dataUrl);
                        } catch (e) {
                            callback(e);
                        }
                    };
                    img.onerror = function (e) { callback(e || new Error('Image load error')); };
                    img.src = ev.target.result;
                };
                reader.onerror = function (e) { callback(e || new Error('File read error')); };
                reader.readAsDataURL(file);
            }

            // file input change
            $('#posterFile').on('change', function (e) {
                const f = this.files && this.files[0];
                if (!f) return;
                // compress & set global
                compressFileToBase64(f, 1200, 0.3, function (err, base64) {
                    if (err) { alert('Greška pri obradi slike'); console.error(err); return; }
                    currentPosterBase64 = base64; // kompletan dataURL
                    $('#previewImg').attr('src', base64).show();
                });
            });

            // Otvori modal za dodavanje
            $('#dugmeDodaj').on('click', function () {
                resetForm();
                $('#naslovModala').text('Dodaj Aranžman');
                dohvatiDostupneSmestaje(); // slobodni
                $('#modalAranzman').show();
            });

            // Otkaži
            $('#dugmeOtkazi').on('click', function () { $('#modalAranzman').hide(); });

            // Save (dodaj/izmeni)
            $('#dugmeSacuvaj').on('click', function () {
                if (isSaving) return;
                // validacija minimalna
                const naziv = $('#naziv').val().trim();
                if (!naziv) { alert('Naziv je obavezan'); return; }
                const tipA = parseEnumValue($('#tipAranzmana').val(), TipMap);
                const tipP = parseEnumValue($('#tipPrevoza').val(), PrevozMap);
                if (tipA === null || tipP === null) { alert('Izaberite tip aranžmana i tip prevoza'); return; }
                const smId = parseInt($('#smestajId').val()) || null;
                if (!smId) { alert('Izaberite smeštaj'); return; }

                const datumP = $('#datumPocetka').val();
                const datumZ = $('#datumZavrsetka').val();
                if (!datumP || !datumZ) { alert('Unesite datume'); return; }

                const payload = {
                    Naziv: naziv,
                    TipAranzmana: tipA,
                    TipPrevoza: tipP,
                    Lokacija: $('#lokacija').val() || '',
                    DatumPocetka: isoToDdMmYyyy(datumP), // dd/MM/yyyy
                    DatumZavrsetka: isoToDdMmYyyy(datumZ),
                    MaksimalanBrojPutnika: parseInt($('#maksPutnika').val()) || 0,
                    Opis: $('#opis').val() || '',
                    ProgramPutovanja: $('#program').val() || '',
                    PosterAranzmana: currentPosterBase64 || null,
                    SmestajId: smId
                };

                const id = $('#idAranzmana').val();
                isSaving = true;
                $('#dugmeSacuvaj').prop('disabled', true);

                if (id) {
                    payload.Id = parseInt(id);
                    $.ajax({
                        url: 'http://localhost:51858/api/aranzmani/update',
                        method: 'PATCH',
                        contentType: 'application/json',
                        data: JSON.stringify(payload)
                    }).done(function () {
                        $('#modalAranzman').hide();
                        dohvatiAranzmane();
                    }).fail(function (xhr) {
                        alert('Greška pri izmeni: ' + (xhr.responseJSON?.message || xhr.statusText));
                    }).always(function () { isSaving = false; $('#dugmeSacuvaj').prop('disabled', false); });
                } else {
                    $.ajax({
                        url: 'http://localhost:51858/api/aranzmani/dodaj',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(payload)
                    }).done(function () {
                        $('#modalAranzman').hide();
                        dohvatiAranzmane();
                    }).fail(function (xhr) {
                        alert('Greška pri dodavanju: ' + (xhr.responseJSON?.message || xhr.statusText));
                    }).always(function () { isSaving = false; $('#dugmeSacuvaj').prop('disabled', false); });
                }
            });

            // Edit: učitaj aranzman i popuni formu
            $('#tabelaAranzmana').on('click', '.dugmeUredi', function () {
                const id = $(this).data('id');
                $.get(`http://localhost:51858/api/aranzmani/get/${id}`)
                    .done(function (resp) {
                        if (!resp || !resp.data) { alert('Nije pronađen aranžman'); return; }
                        const a = resp.data;
                        $('#idAranzmana').val(a.Id);
                        $('#naziv').val(a.Naziv || '');
                        // popuni tipovi (može doći kao broj ili string)
                        const tipA = parseEnumValue(a.TipAranzmana, TipMap);
                        if (tipA !== null) $('#tipAranzmana').val(tipA);
                        const tipP = parseEnumValue(a.TipPrevoza, PrevozMap);
                        if (tipP !== null) $('#tipPrevoza').val(tipP);

                        // datum: server čuva dd/MM/yyyy - convert to iso yyyy-mm-dd for input
                        if (a.DatumPocetka) {
                            // ako je dd/mm/yyyy
                            if (a.DatumPocetka.indexOf('/') >= 0) $('#datumPocetka').val(ddmmyyyyToIso(a.DatumPocetka));
                            else $('#datumPocetka').val(a.DatumPocetka.substring(0, 10));
                        } else $('#datumPocetka').val('');

                        if (a.DatumZavrsetka) {
                            if (a.DatumZavrsetka.indexOf('/') >= 0) $('#datumZavrsetka').val(ddmmyyyyToIso(a.DatumZavrsetka));
                            else $('#datumZavrsetka').val(a.DatumZavrsetka.substring(0, 10));
                        } else $('#datumZavrsetka').val('');

                        $('#maksPutnika').val(a.MaksimalanBrojPutnika || a.MaksPutnika || 0);
                        $('#lokacija').val(a.Lokacija || '');
                        $('#opis').val(a.Opis || '');
                        $('#program').val(a.ProgramPutovanja || '');

                        // poster: ako postoji, popuni preview i currentPosterBase64
                        if (a.PosterAranzmana) {
                            currentPosterBase64 = a.PosterAranzmana;
                            $('#previewImg').attr('src', currentPosterBase64).show();
                        } else {
                            currentPosterBase64 = null;
                            $('#previewImg').hide();
                        }

                        // smestaj select: load free + ensure current is shown/selected
                        dohvatiDostupneSmestaje(a.SmestajId);

                        $('#naslovModala').text('Uredi Aranžman');
                        $('#modalAranzman').show();
                    })
                    .fail(function () { alert('Greška pri učitavanju aranžmana'); });
            });

            // Delete (logičko)
            $('#tabelaAranzmana').on('click', '.dugmeObrisi', function () {
                const id = $(this).data('id');
                if (!confirm('Da li ste sigurni da želite da obrišete ovaj aranžman?')) return;
                $.ajax({
                    url: `http://localhost:51858/api/aranzmani/delete/${id}`,
                    method: 'PATCH'
                }).done(function () {
                    dohvatiAranzmane();
                }).fail(function (xhr) {
                    alert('Greška pri brisanju: ' + (xhr.responseJSON?.message || xhr.statusText));
                });
            });

            // filtriranje UI
            $('#dugmeFiltriraj').on('click', function () {
                const nazivFilter = $('#pretragaNaziv').val().toLowerCase();
                const tipFilter = $('#pretragaTip').val();
                $('#tabelaAranzmana tbody tr').each(function () {
                    const naziv = $(this).find('td:eq(0)').text().toLowerCase();
                    const tip = $(this).find('td:eq(1)').text();
                    const prikazi = (!nazivFilter || naziv.includes(nazivFilter)) && (!tipFilter || tip === $('#pretragaTip option:selected').text());
                    $(this).toggle(prikazi);
                });
            });

            // reset UI
            $('#dugmeResetuj').on('click', function () { $('#pretragaNaziv, #pretragaTip').val(''); $('#tabelaAranzmana tbody tr').show(); });

            // reset forme helper
            function resetForm() {
                $('#idAranzmana').val('');
                $('#naziv').val('');
                $('#tipAranzmana').val('');
                $('#tipPrevoza').val('');
                $('#datumPocetka').val('');
                $('#datumZavrsetka').val('');
                $('#maksPutnika').val('');
                $('#lokacija').val('');
                $('#opis').val('');
                $('#program').val('');
                $('#smestajId').val('');
                $('#posterFile').val('');
                currentPosterBase64 = null;
                $('#previewImg').hide().attr('src', '');
            }
           
            // init
            dohvatiAranzmane();
        });
    </script>
</body>
</html>
