<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="../Content/tailwind.css" rel="stylesheet" />
    <script src="../Scripts/jquery-3.7.1.min.js"></script>
    <title>Turistički aranžmani | Početna</title>
    <script>
        $(document).ready(function () {
            $("#navigacioni-meni").load("/Static/NavigacioniMeni.html");

            preuzmiAranzmane();

            $("#datumPocetkaOd, #datumPocetkaDo, #datumZavrsetkaOd, #datumZavrsetkaDo, #tipPrevoza, #tipAranzmana, #nazivAranzmana")
                .on("input change", filtrirajAranzmane);

            $("#sortNazivRastuce").on("click", () => sortirajAranzmane("naziv-rastuce"));
            $("#sortNazivOpadajuce").on("click", () => sortirajAranzmane("naziv-opadajuce"));
            $("#sortDatumPocetkaRastuce").on("click", () => sortirajAranzmane("pocetak-rastuce"));
            $("#sortDatumPocetkaOpadajuce").on("click", () => sortirajAranzmane("pocetak-opadajuce"));
            $("#sortDatumZavrsetkaRastuce").on("click", () => sortirajAranzmane("zavrsetak-rastuce"));
            $("#sortDatumZavrsetkaOpadajuce").on("click", () => sortirajAranzmane("zavrsetak-opadajuce"));
            $("#resetFilter").on("click", resetujFiltere);
        });

        let aranzmani = [];

        function preuzmiAranzmane() {
            $.ajax({
                url: "http://localhost:51858/api/aranzmani/predstojeci",
                method: "GET",
                success: function (response) {
                    aranzmani = response.data || [];
                    prikaziAranzmane(aranzmani);
                },
                error: function () { console.error("Greška pri preuzimanju aranžmana"); }
            });
        }

        function prikaziAranzmane(lista) {
            const container = $("#aranzmani-container");
            container.empty();

            lista.forEach(a => {
                const pocetak = formatirajDatumPrikaz(a.DatumPocetka);
                const zavrsetak = formatirajDatumPrikaz(a.DatumZavrsetka);

                const elem = $(`
                     <div class="h-auto rounded-lg bg-white mb-8 shadow-lg overflow-hidden flex flex-col lg:flex-row">
                        <div class="lg:w-1/3 h-48 lg:h-auto">
                          <img src="${a.PosterAranzmana || 'https://via.placeholder.com/400x300?text=Aranzman'}" 
                                class="w-full h-full object-cover" alt="Poster aranžmana">
                        </div>
                        <div class="p-4 lg:w-2/3 flex flex-col justify-between">
                            <div>
                                <h3 class="text-2xl font-bold mb-2">${a.Naziv}</h3>
                                <p><b>Tip aranžmana:</b> ${a.TipAranzmana}</p>
                                <p><b>Tip prevoza:</b> ${a.TipPrevoza}</p>
                                <p><b>Lokacija:</b> ${a.Lokacija || '-'}</p>
                                <p><b>Datum putovanja:</b> ${pocetak} - ${zavrsetak}</p>
                            </div>
                        <div class="mt-4 flex gap-2">
                            <button class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 dugme-detalji" data-id="${a.Id}">
                                Detalji
                            </button>
                        </div>
                     </div>
                    </div>
    `           );

                container.append(elem);
            });

            // Funkcija za lep prikaz datuma: dd.MM.yyyy
            function formatirajDatumPrikaz(datumStr) {
                const d = new Date(datumStr);
                const dan = String(d.getDate()).padStart(2, '0');
                const mesec = String(d.getMonth() + 1).padStart(2, '0');
                const godina = d.getFullYear();
                return `${dan}.${mesec}.${godina}`;
            }

            // bind dugmad
            $(".dugme-detalji").on("click", function () {
                const id = $(this).data("id");
                window.location.href = `/Static/DetaljiAranzmana.html?id=${id}`;
            });

            $(".dugme-rezervisi").on("click", function () {
                const id = $(this).data("id");
                rezervisiAranzman(id);
            });
        }

            function rezervisiAranzman(aranzmanId) {
                // backend logika: pronalazi slobodnu smestajnu jedinicu i rezervise
                $.ajax({
                    url: `http://localhost:51858/api/rezervacije/rezerwisi/${aranzmanId}`,
                    method: "POST",
                    success: function () {
                        alert("Rezervacija je uspešno izvršena!");
                    },
                    error: function (xhr) {
                        alert("Greška pri rezervaciji: " + (xhr.responseJSON?.message || xhr.statusText));
                    }
                });
            }

            function filtrirajAranzmane() {
                const pocetakOd = $("#datumPocetkaOd").val();
                const pocetakDo = $("#datumPocetkaDo").val();
                const zavrsetakOd = $("#datumZavrsetkaOd").val();
                const zavrsetakDo = $("#datumZavrsetkaDo").val();
                const tipPrevoza = $("#tipPrevoza").val();
                const tipAranzmana = $("#tipAranzmana").val();
                const naziv = $("#nazivAranzmana").val().toLowerCase();

                const filtrirani = aranzmani.filter(a => {
                    const datumPocetka = a.DatumPocetka.substring(0, 10); // yyyy-mm-dd
                    const datumZavrsetka = a.DatumZavrsetka.substring(0, 10);

                    return (!pocetakOd || datumPocetka >= pocetakOd)
                        && (!pocetakDo || datumPocetka <= pocetakDo)
                        && (!zavrsetakOd || datumZavrsetka >= zavrsetakOd)
                        && (!zavrsetakDo || datumZavrsetka <= zavrsetakDo)
                        && (!tipPrevoza || a.TipPrevoza === tipPrevoza)
                        && (!tipAranzmana || a.TipAranzmana === tipAranzmana)
                        && (!naziv || a.Naziv.toLowerCase().includes(naziv));
                });

                prikaziAranzmane(filtrirani);
            }

            function sortirajAranzmane(nacin) {
                const lista = [...aranzmani];
                switch (nacin) {
                    case "naziv-rastuce": lista.sort((a, b) => a.Naziv.localeCompare(b.Naziv)); break;
                    case "naziv-opadajuce": lista.sort((a, b) => b.Naziv.localeCompare(a.Naziv)); break;
                    case "pocetak-rastuce": lista.sort((a, b) => new Date(a.DatumPocetka) - new Date(b.DatumPocetka)); break;
                    case "pocetak-opadajuce": lista.sort((a, b) => new Date(b.DatumPocetka) - new Date(a.DatumPocetka)); break;
                    case "zavrsetak-rastuce": lista.sort((a, b) => new Date(a.DatumZavrsetka) - new Date(b.DatumZavrsetka)); break;
                    case "zavrsetak-opadajuce": lista.sort((a, b) => new Date(b.DatumZavrsetka) - new Date(a.DatumZavrsetka)); break;
                }
                prikaziAranzmane(lista);
            }

            function resetujFiltere() {
                $("#datumPocetkaOd, #datumPocetkaDo, #datumZavrsetkaOd, #datumZavrsetkaDo, #tipPrevoza, #tipAranzmana, #nazivAranzmana").val('');
                prikaziAranzmane(aranzmani);
            }

            function formatirajDatum(datum) {
                const dan = String(datum.getDate()).padStart(2, '0');
                const mesec = String(datum.getMonth() + 1).padStart(2, '0');
                const godina = datum.getFullYear();
                return `${godina}-${mesec}-${dan}`;
            }
    </script>
</head>

<body class="mb-8">
    <div id="navigacioni-meni" class="w-full"></div>

    <div class="mt-12 mx-40">
        <h1 class="text-3xl pb-8 font-semibold">Pretraga predstojećih aranžmana</h1>

        <div class="grid grid-cols-1 gap-4 lg:grid-cols-3 lg:gap-8 mb-6">
            <!-- Filter polja ostaju ista -->
            <div>
                <label for="datumPocetkaOd" class="block text-sm font-medium text-gray-700 mb-1">Datum početka od:</label>
                <input type="date" id="datumPocetkaOd" class="p-2 border border-blue-500 outline-none rounded-lg w-full" />
            </div>
            <div>
                <label for="datumPocetkaDo" class="block text-sm font-medium text-gray-700 mb-1">Datum početka do:</label>
                <input type="date" id="datumPocetkaDo" class="p-2 border border-blue-500 outline-none rounded-lg w-full" />
            </div>
            <div>
                <label for="datumZavrsetkaOd" class="block text-sm font-medium text-gray-700 mb-1">Datum završetka od:</label>
                <input type="date" id="datumZavrsetkaOd" class="p-2 border border-blue-500 outline-none rounded-lg w-full" />
            </div>
            <div>
                <label for="datumZavrsetkaDo" class="block text-sm font-medium text-gray-700 mb-1">Datum završetka do:</label>
                <input type="date" id="datumZavrsetkaDo" class="p-2 border border-blue-500 outline-none rounded-lg w-full" />
            </div>
            <div>
                <label for="tipPrevoza" class="block text-sm font-medium text-gray-700 mb-1">Tip prevoza:</label>
                <select id="tipPrevoza" class="p-2 border border-blue-500 outline-none rounded-lg w-full">
                    <option value="">Svi tipovi prevoza</option>
                    <option value="Autobus">Autobus</option>
                    <option value="Avion">Avion</option>
                    <option value="Autobus+Avion">Autobus+Avion</option>
                    <option value="Individualan">Individualan</option>
                    <option value="Ostalo">Ostalo</option>
                </select>
            </div>
            <div>
                <label for="tipAranzmana" class="block text-sm font-medium text-gray-700 mb-1">Tip aranžmana:</label>
                <select id="tipAranzmana" class="p-2 border border-blue-500 outline-none rounded-lg w-full">
                    <option value="">Svi tipovi aranžmana</option>
                    <option value="NocenjeSDoručkom">Noćenje sa doručkom</option>
                    <option value="Polupansion">Polupansion</option>
                    <option value="PunPansion">Pun pansion</option>
                    <option value="AllInclusive">All inclusive</option>
                    <option value="NajamApartmana">Najam apartmana</option>
                </select>
            </div>
            <div>
                <label for="nazivAranzmana" class="block text-sm font-medium text-gray-700 mb-1">Naziv aranžmana:</label>
                <input type="text" id="nazivAranzmana" placeholder="Naziv aranžmana" class="p-2 border border-blue-500 outline-none rounded-lg w-full" />
            </div>
        </div>

        <div class="flex gap-2 mb-10">
            <button id="resetFilter" class="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600">Resetuj filtere</button>
            <button id="sortNazivRastuce" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Sortiraj po nazivu (rastuce)</button>
            <button id="sortNazivOpadajuce" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Sortiraj po nazivu (opadajuce)</button>
            <button id="sortDatumPocetkaRastuce" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Sortiraj po početku (rastuce)</button>
            <button id="sortDatumPocetkaOpadajuce" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Sortiraj po početku (opadajuce)</button>
            <button id="sortDatumZavrsetkaRastuce" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Sortiraj po završetku (rastuce)</button>
            <button id="sortDatumZavrsetkaOpadajuce" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Sortiraj po završetku (opadajuce)</button>
        </div>
    </div>

    <div class="mx-40 mt-12">
        <h1 class="text-3xl font-semibold mb-6">Dostupni aranžmani</h1>
        <div class="grid grid-cols-1 gap-4 lg:grid-cols-2 lg:gap-8" id="aranzmani-container"></div>
    </div>
</body>
</html>
